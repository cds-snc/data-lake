{
    "Job": {
        "Name": "Operations / GoogleAnalytics / DailyPages",
        "JobMode": "VISUAL",
        "JobRunQueuingEnabled": false,
        "Description": "",
        "Role": "arn:aws:iam::739275439843:role/service-role/AWSGlueETL-DataLake",
        "CreatedOn": "2025-12-18T20:44:51.146000+00:00",
        "LastModifiedOn": "2025-12-29T14:23:16.088000+00:00",
        "ExecutionProperty": {
            "MaxConcurrentRuns": 1
        },
        "Command": {
            "Name": "glueetl",
            "ScriptLocation": "s3://aws-glue-assets-739275439843-ca-central-1/scripts/Operations / GoogleAnalytics /Operations / GoogleAnalytics /Operations / GoogleAnalytics / DailyPages.py",
            "PythonVersion": "3"
        },
        "DefaultArguments": {
            "--enable-metrics": "true",
            "--enable-spark-ui": "true",
            "--spark-event-logs-path": "s3://aws-glue-assets-739275439843-ca-central-1/sparkHistoryLogs/",
            "--enable-job-insights": "true",
            "--enable-observability-metrics": "true",
            "--enable-glue-datacatalog": "true",
            "--job-bookmark-option": "job-bookmark-enable",
            "--job-language": "python",
            "--TempDir": "s3://aws-glue-assets-739275439843-ca-central-1/temporary/"
        },
        "MaxRetries": 0,
        "AllocatedCapacity": 10,
        "Timeout": 480,
        "MaxCapacity": 10.0,
        "WorkerType": "G.1X",
        "NumberOfWorkers": 10,
        "GlueVersion": "5.0",
        "CodeGenConfigurationNodes": {
            "node-1765980720494": {
                "S3JsonSource": {
                    "Name": "Superset",
                    "Paths": [
                        "s3://cds-data-lake-raw-production/operations/google-analytics/platform_core_superset_doc/daily_pages/"
                    ],
                    "Exclusions": [],
                    "Recurse": true,
                    "AdditionalOptions": {
                        "EnableSamplePath": false,
                        "SamplePath": "s3://cds-data-lake-raw-production/operations/google-analytics/platform_core_superset_doc/daily_pages/date=2025-11-12/data.json"
                    },
                    "JsonPath": "",
                    "Multiline": false,
                    "OutputSchemas": [
                        {
                            "Columns": [
                                {
                                    "Name": "date",
                                    "Type": "string"
                                },
                                {
                                    "Name": "firstusermanualcampaignname",
                                    "Type": "string"
                                },
                                {
                                    "Name": "sessions",
                                    "Type": "string"
                                },
                                {
                                    "Name": "activeusers",
                                    "Type": "string"
                                }
                            ]
                        }
                    ]
                }
            },
            "node-1765980721031": {
                "S3JsonSource": {
                    "Name": "Client",
                    "Paths": [
                        "s3://cds-data-lake-raw-production/operations/google-analytics/platform_form_client/daily_pages/"
                    ],
                    "Exclusions": [],
                    "Recurse": true,
                    "AdditionalOptions": {
                        "EnableSamplePath": false,
                        "SamplePath": "s3://cds-data-lake-raw-production/operations/google-analytics/platform_form_client/daily_pages/date=2025-11-11/data.json"
                    },
                    "JsonPath": "",
                    "Multiline": false,
                    "OutputSchemas": [
                        {
                            "Columns": [
                                {
                                    "Name": "date",
                                    "Type": "string"
                                },
                                {
                                    "Name": "pagetitle",
                                    "Type": "string"
                                },
                                {
                                    "Name": "sessions",
                                    "Type": "string"
                                },
                                {
                                    "Name": "activeusers",
                                    "Type": "string"
                                },
                                {
                                    "Name": "bouncerate",
                                    "Type": "string"
                                },
                                {
                                    "Name": "userengagementduration",
                                    "Type": "string"
                                }
                            ]
                        }
                    ]
                }
            },
            "node-1767017738055": {
                "SelectFromCollection": {
                    "Name": "Select From Collection",
                    "Inputs": [
                        "node-1767017554206"
                    ],
                    "Index": 0
                }
            },
            "node-1767017554206": {
                "CustomCode": {
                    "Name": "Custom Transform",
                    "Inputs": [
                        "node-1765980720494",
                        "node-1765980721031",
                        "node-1765979699147",
                        "node-1765980620381"
                    ],
                    "Code": "from awsglue.dynamicframe import DynamicFrame, DynamicFrameCollection\nfrom pyspark.sql.types import StructType, StructField, StringType\nfrom pyspark.sql import functions as F\nspark = glueContext.spark_session\n\nBASE_SCHEMA = StructType([\n    StructField(\"date\", StringType(), True),  # yyyyMMdd\n    StructField(\"pagetitle\", StringType(), True),\n    StructField(\"sessions\", StringType(), True),\n    StructField(\"activeusers\", StringType(), True),\n    StructField(\"bouncerate\", StringType(), True),\n    StructField(\"userengagementduration\", StringType(), True),\n])\n\nsuperset     = dfc.select(list(dfc.keys())[0]).toDF()\nclient       = dfc.select(list(dfc.keys())[1]).toDF()\nmarketing    = dfc.select(list(dfc.keys())[2]).toDF()\nnotification = dfc.select(list(dfc.keys())[3]).toDF()\n\ndef normalize(df, ga_property):\n    if len(df.take(1)) == 0:\n        df = spark.createDataFrame([], BASE_SCHEMA)\n\n    return (\n        df\n        .withColumn(\"date\", F.to_date(F.col(\"date\"), \"yyyyMMdd\"))\n\n        # numeric conversions (keep null on blanks)\n        .withColumn(\"sessions\", F.when(F.trim(F.col(\"sessions\")) == \"\", None).otherwise(F.col(\"sessions\")).cast(\"int\"))\n        .withColumn(\"activeusers\", F.when(F.trim(F.col(\"activeusers\")) == \"\", None).otherwise(F.col(\"activeusers\")).cast(\"int\"))\n        .withColumn(\"bouncerate\", F.when(F.trim(F.col(\"bouncerate\")) == \"\", None).otherwise(F.col(\"bouncerate\")).cast(\"double\"))\n        .withColumn(\"userengagementduration\", F.when(F.trim(F.col(\"userengagementduration\")) == \"\", None).otherwise(F.col(\"userengagementduration\")).cast(\"int\"))\n\n        .withColumn(\"pagetitle\", F.col(\"pagetitle\").cast(\"string\"))\n\n        .select(\"date\", \"pagetitle\", \"sessions\", \"activeusers\", \"bouncerate\", \"userengagementduration\")\n        .withColumn(\"ga_property\", F.lit(ga_property))\n        .select(\"ga_property\", \"date\", \"pagetitle\", \"sessions\", \"activeUsers\", \"bounceRate\", \"userEngagementDuration\")\n    )\n\ncombined = (\n    normalize(superset,     \"platform_core_superset_doc\")\n    .unionByName(normalize(client,       \"platform_form_client\"), allowMissingColumns=True)\n    .unionByName(normalize(marketing,    \"forms_marketing_site\"), allowMissingColumns=True)\n    .unionByName(normalize(notification, \"notification_ga4\"), allowMissingColumns=True)\n)\n\nreturn DynamicFrameCollection(\n    {\"output\": DynamicFrame.fromDF(combined, glueContext, \"output\")},\n    glueContext\n)",
                    "ClassName": "MyTransform",
                    "OutputSchemas": [
                        {
                            "Columns": [
                                {
                                    "Name": "ga_property",
                                    "Type": "string"
                                },
                                {
                                    "Name": "date",
                                    "Type": "date"
                                },
                                {
                                    "Name": "pagetitle",
                                    "Type": "string"
                                },
                                {
                                    "Name": "sessions",
                                    "Type": "int"
                                },
                                {
                                    "Name": "activeUsers",
                                    "Type": "int"
                                },
                                {
                                    "Name": "bounceRate",
                                    "Type": "double"
                                },
                                {
                                    "Name": "userEngagementDuration",
                                    "Type": "int"
                                }
                            ]
                        }
                    ]
                }
            },
            "node-1766089243013": {
                "S3GlueParquetTarget": {
                    "Name": "Amazon S3",
                    "Inputs": [
                        "node-1767017738055"
                    ],
                    "PartitionKeys": [],
                    "Path": "s3://cds-data-lake-transformed-production/operations/google-analytics/daily_pages/",
                    "Compression": "snappy",
                    "NumberTargetPartitions": "0",
                    "SchemaChangePolicy": {
                        "EnableUpdateCatalog": true,
                        "UpdateBehavior": "UPDATE_IN_DATABASE",
                        "Table": "operations_google_analytics_daily_pages",
                        "Database": "operations_google_analytics_production"
                    },
                    "AutoDataQuality": {
                        "IsEnabled": true,
                        "EvaluationContext": "EvaluateDataQuality_node1766089210397"
                    }
                }
            },
            "node-1765979699147": {
                "S3JsonSource": {
                    "Name": "Marketing",
                    "Paths": [
                        "s3://cds-data-lake-raw-production/operations/google-analytics/forms_marketing_site/daily_pages/"
                    ],
                    "Exclusions": [],
                    "Recurse": true,
                    "AdditionalOptions": {
                        "EnableSamplePath": false,
                        "SamplePath": "s3://cds-data-lake-raw-production/operations/google-analytics/forms_marketing_site/daily_pages/date=2025-11-11/data.json"
                    },
                    "JsonPath": "",
                    "Multiline": false,
                    "OutputSchemas": [
                        {
                            "Columns": [
                                {
                                    "Name": "date",
                                    "Type": "string"
                                },
                                {
                                    "Name": "pagetitle",
                                    "Type": "string"
                                },
                                {
                                    "Name": "sessions",
                                    "Type": "string"
                                },
                                {
                                    "Name": "activeusers",
                                    "Type": "string"
                                },
                                {
                                    "Name": "bouncerate",
                                    "Type": "string"
                                },
                                {
                                    "Name": "userengagementduration",
                                    "Type": "string"
                                }
                            ]
                        }
                    ]
                }
            },
            "node-1765980620381": {
                "S3JsonSource": {
                    "Name": "Notification",
                    "Paths": [
                        "s3://cds-data-lake-raw-production/operations/google-analytics/notification_ga4/daily_pages/"
                    ],
                    "Exclusions": [],
                    "Recurse": true,
                    "AdditionalOptions": {
                        "EnableSamplePath": false,
                        "SamplePath": "s3://cds-data-lake-raw-production/operations/google-analytics/notification_ga4/daily_pages/date=2025-11-11/data.json"
                    },
                    "JsonPath": "",
                    "Multiline": false,
                    "OutputSchemas": [
                        {
                            "Columns": [
                                {
                                    "Name": "date",
                                    "Type": "string"
                                },
                                {
                                    "Name": "pagetitle",
                                    "Type": "string"
                                },
                                {
                                    "Name": "sessions",
                                    "Type": "string"
                                },
                                {
                                    "Name": "activeusers",
                                    "Type": "string"
                                },
                                {
                                    "Name": "bouncerate",
                                    "Type": "string"
                                },
                                {
                                    "Name": "userengagementduration",
                                    "Type": "string"
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "ExecutionClass": "STANDARD"
    }
}
